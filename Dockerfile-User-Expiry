# -----------------------------
# Builder Stage
# -----------------------------
FROM golang:1.25.0 AS builder

ENV CGO_ENABLED=1
ENV GOOS=linux
ENV GOARCH=amd64

# Optional: copy common packages if used
RUN mkdir /common
COPY services/common /common

# Set working directory
WORKDIR /app

# Copy Go module files first for caching
COPY services/user_expiry/go.mod services/user_expiry/go.sum ./

RUN go mod download

# Copy the rest of the source
COPY services/user_expiry .

# Build the binary with optional size optimization
RUN go build -ldflags="-s -w" -o user_expiry main.go

# -----------------------------
# Final Stage
# -----------------------------
FROM debian:trixie-slim

# Install runtime dependencies only
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        sqlite3 \
        libsqlite3-dev && \
    rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy the Go binary from the builder stage
COPY --from=builder /app/user_expiry /usr/local/bin/user_expiry

COPY services/user_expiry/scripts/start.sh /start.sh

RUN chmod +x /start.sh

# Make binary executable
RUN chmod +x /usr/local/bin/user_expiry

# Set up volume for database persistence
VOLUME ["/usr/local/bin/db", "/usr/local/bin/cron_journal"]

# Default command
CMD ["/start.sh"]
